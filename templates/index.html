<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>테스트서버</title>
<style>
body { 
  font-family: system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans KR',Arial; 
  margin:0; 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  min-height:100vh; 
  background:#f6f8fa;
}

.card { 
  background:white; 
  padding:28px; 
  border-radius:12px; 
  box-shadow:0 6px 30px rgba(20,20,40,0.08); 
  max-width:520px; 
  width:calc(100%-48px); 
  text-align:center;
  position:relative;
}

.login-btn { 
  position:absolute; 
  top:16px; 
  right:16px; 
  background:#007bff; 
  color:white; 
  border:none; 
  border-radius:8px; 
  padding:8px 14px; 
  font-size:0.95rem; 
  cursor:pointer; 
  transition:background 0.2s;
}
.login-btn:hover { background:#0056b3; }

.lp-container {
  position: relative;
  width: 300px;
  height: 300px;
  border-radius: 50%;
  box-shadow: 0 15px 30px rgba(0,0,0,0.2);
  margin: 0 auto 20px auto;
  overflow: hidden;
  z-index: 10; /* ✅ CD가 항상 위에 표시되도록 */
}

.lp-container img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
  display: block;
  transform-origin: center;
}

.lp-container::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 50px;
  height: 50px;
  background-color: #ffffff;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
}

.controls {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 30px;
}

.control-btn {
  width: 60px;
  height: 60px;
  background: linear-gradient(145deg, #c0c0c0, #6b6b6b);
  border: 2px solid #999;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: inset -2px -2px 5px rgba(255,255,255,0.5), 
              inset 2px 2px 5px rgba(0,0,0,0.3),
              0 5px 15px rgba(0,0,0,0.4);
  transition: transform 0.1s;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
}

.control-btn:hover { transform: scale(1.1); }

#songTitle {
  margin-top: 10px;
  font-size: 18px;
  font-weight: bold;
  color: #333;
}

/* 재생 바 */
.progress-container {
  width: 100%;
  height: 8px;
  background: #e5e5e5;
  border-radius: 5px;
  overflow: hidden;
  margin-top: 16px;
  cursor: pointer;
  position: relative;
}

.progress {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #007bff, #66b3ff);
  border-radius: 5px;
  transition: width 0.2s linear;
}

/* 애니메이션 */
@keyframes cdOutRight {
  0% { transform: scale(1) translateX(0); opacity: 1; }
  50% { transform: scale(1.3) translateX(0); opacity: 1; }
  100% { transform: scale(1.3) translateX(400px); opacity: 0; }
}

@keyframes cdOutLeft {
  0% { transform: scale(1) translateX(0); opacity: 1; }
  50% { transform: scale(1.3) translateX(0); opacity: 1; }
  100% { transform: scale(1.3) translateX(-400px); opacity: 0; }
}

@keyframes cdInRight {
  0% { transform: scale(1.3) translateX(400px); opacity: 0; }
  50% { transform: scale(1.3) translateX(0); opacity: 1; }
  100% { transform: scale(1) translateX(0); opacity: 1; }
}

@keyframes cdInLeft {
  0% { transform: scale(1.3) translateX(-400px); opacity: 0; }
  50% { transform: scale(1.3) translateX(0); opacity: 1; }
  100% { transform: scale(1) translateX(0); opacity: 1; }
}

/* 접속 기록 상태 표시 */
#meta {
  margin-top: 12px;
  font-size: 0.9rem;
  color: #666;
}
</style>
</head>
<body>

<button class="login-btn" onclick="window.location.href='/login'">로그인</button>

<div class="card">
  <div class="lp-container" id="lp">
    <img id="albumImg" src="https://image.genie.co.kr/Y/IMAGE/IMG_ALBUM/083/809/794/83809794_1684804647260_1_600x600.JPG" alt="앨범 커버">
  </div>

  <div class="controls">
    <button class="control-btn" id="prevBtn">⏮</button>
    <button class="control-btn" id="playBtn">▶️</button>
    <button class="control-btn" id="nextBtn">⏭</button>
  </div>

  <div id="songTitle">알레프 - 사과향</div>

  <div class="progress-container" id="progressContainer">
    <div class="progress" id="progress"></div>
  </div>

  <div id="meta">서버 상태 확인 중...</div>

  <audio id="audio">
     <source src="{{ url_for('static', filename='apple.mp3') }}" type="audio/mpeg">
  </audio>
</div>

<script>
// ✅ 접속 기록
async function recordVisit() {
  const metaEl = document.getElementById('meta');
  try {
    const res = await fetch('/record', { method: 'POST' });
    if (res.ok) metaEl.textContent = '접속 기록 완료 • 서버 연결 정상';
    else metaEl.textContent = '서버 응답 오류';
  } catch (err) {
    metaEl.textContent = '서버에 연결할 수 없습니다.';
  }
}
recordVisit();

// ✅ 음악 플레이어
const lp = document.getElementById('lp');
const albumImg = document.getElementById('albumImg');
const playBtn = document.getElementById('playBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const audio = document.getElementById('audio');
const songTitle = document.getElementById('songTitle');
const progress = document.getElementById('progress');
const progressContainer = document.getElementById('progressContainer');

const songs = [
  {
    title: '알레프 - 사과향',
    src: "{{ url_for('static', filename='apple.mp3') }}",
    img: 'https://image.genie.co.kr/Y/IMAGE/IMG_ALBUM/083/809/794/83809794_1684804647260_1_600x600.JPG'
  },
  {
    title: '레드벨벳 - Chill Kill',
    src: "{{ url_for('static', filename='chillkill.mp3') }}",
    img: 'https://i.namu.wiki/i/7Rl3b3w6JodPtLitLWmt1skV-WyHcq1xQD3u3OpypcduP_hvHh6InGpCqJShFwFWnAzPRBoq1R50UZJCMHGYfQ.webp'
  },
  {
    title: '리도어 - 0g 愛錘',
    src: "{{ url_for('static', filename='0gachu.mp3') }}",
    img: 'https://image.genie.co.kr/Y/IMAGE/IMG_ALBUM/084/688/210/84688210_1705025840656_1_600x600.JPG'
  }
];

let currentIndex = 0;
let isPlaying = false;
let currentRotation = 0;
let spinFrame;

function rotateStep() {
  if (isPlaying) {
    currentRotation += 0.4;
    albumImg.style.transform = `rotate(${currentRotation}deg)`;
    spinFrame = requestAnimationFrame(rotateStep);
  }
}

function startRotation() {
  cancelAnimationFrame(spinFrame);
  rotateStep();
}

function stopRotation() {
  cancelAnimationFrame(spinFrame);
}

function updateSong(index) {
  const song = songs[index];
  albumImg.src = song.img;
  songTitle.textContent = song.title;
  audio.src = song.src;
  document.body.style.background = index === 0 
    ? '#f6f8fa' 
    : index === 1 
    ? '#f3f0ff' 
    : '#fff6f6';
}

function togglePlay() {
  if (!isPlaying) {
    isPlaying = true;
    audio.play();
    startRotation();
    playBtn.textContent = '⏸️';
  } else {
    isPlaying = false;
    audio.pause();
    stopRotation();
    playBtn.textContent = '▶️';
  }
}

playBtn.addEventListener('click', togglePlay);

audio.addEventListener('ended', () => {
  isPlaying = false;
  stopRotation();
  playBtn.textContent = '▶️';
});

function changeSong(next = true) {
  const outAnim = next ? 'cdOutLeft' : 'cdOutRight';
  const inAnim = next ? 'cdInRight' : 'cdInLeft';

  lp.style.animation = `${outAnim} 1s ease forwards`;

  stopRotation();
  currentRotation = 0;
  albumImg.style.transform = `rotate(0deg)`;

  setTimeout(() => {
    currentIndex = (currentIndex + (next ? 1 : -1) + songs.length) % songs.length;
    updateSong(currentIndex);
    lp.style.animation = `${inAnim} 1s ease forwards`;

    if (isPlaying) {
      audio.play();
      startRotation();
    }
  }, 1000);
}

nextBtn.addEventListener('click', () => changeSong(true));
prevBtn.addEventListener('click', () => changeSong(false));

audio.addEventListener('timeupdate', () => {
  const percent = (audio.currentTime / audio.duration) * 100;
  progress.style.width = `${percent}%`;
});

progressContainer.addEventListener('click', (e) => {
  const width = progressContainer.clientWidth;
  const clickX = e.offsetX;
  const duration = audio.duration;
  audio.currentTime = (clickX / width) * duration;
});
</script>

</body>
</html>
